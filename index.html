<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ç½‘ç»œå®‰å…¨æœ¬åœ°çŸ¥è¯†ä¸­æ¢</title>
<style>
  body{margin:0;font-family:"Segoe UI","Microsoft YaHei",sans-serif;background:#fff;color:#111827;}
  header{height:60px;background:#f3f4f6;display:flex;align-items:center;justify-content:space-between;
         padding:0 18px;border-bottom:1px solid #e5e7eb;}
  header .t{font-size:16px;color:#1d4ed8;font-weight:700}
  header .s{font-size:12px;color:#6b7280}
  .wrap{display:flex;height:calc(100vh - 60px);}
  nav{width:220px;background:#f9fafb;border-right:1px solid #e5e7eb;padding:14px 0;}
  nav a{display:block;padding:10px 18px;color:#374151;text-decoration:none;font-size:14px;}
  nav a.active,nav a:hover{background:#e5e7eb;color:#1d4ed8;}
  main{flex:1;padding:18px;overflow:auto;}
  .bar{display:flex;gap:10px;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;
       padding:12px;margin-bottom:14px;}
  .bar input{flex:1;border:1px solid #d1d5db;border-radius:8px;padding:10px;outline:none;}
  .bar button{border:0;border-radius:8px;padding:10px 16px;background:#1d4ed8;color:#fff;font-weight:700;cursor:pointer;}
  .bar button:disabled{opacity:.6;cursor:not-allowed;}
  .meta{display:flex;gap:10px;align-items:center;margin:8px 2px 14px;color:#6b7280;font-size:12px;}
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;}
  .card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:14px;}
  .card h3{margin:0 0 8px 0;font-size:15px;color:#1d4ed8;}
  .card p{margin:0;color:#374151;font-size:13px;line-height:1.6;}
  .tags{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;}
  .tag{font-size:12px;background:#e5e7eb;color:#111827;border-radius:999px;padding:4px 10px;}
  .pill{font-size:12px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 10px;}
  .err{border:1px solid #fecaca;background:#fef2f2;color:#991b1b;padding:10px 12px;border-radius:10px;margin-top:10px;display:none;}
  footer{padding:10px 2px;color:#6b7280;font-size:12px;}
</style>
</head>
<body>
<header>
  <div class="t">ç½‘ç»œå®‰å…¨æœ¬åœ°çŸ¥è¯†ä¸­æ¢ï¼ˆæ—  GPUï¼‰</div>
  <div class="s">å…¥å£ï¼š80ç«¯å£ï¼ˆNginxï¼‰ / APIï¼š/api/search</div>
</header>

<div class="wrap">
  <nav>
    <a class="active">ğŸ” çŸ¥è¯†æœç´¢</a>
    <a>ğŸ“š æ¼æ´çŸ¥è¯†åº“</a>
    <a>âš”ï¸ çº¢è“é˜ŸçŸ¥è¯†</a>
    <a>ğŸ§© å®‰å…¨æœåŠ¡èƒ½åŠ›</a>
    <a>ğŸ”— çŸ¥è¯†å…³è”åˆ†æ</a>
    <a>ğŸ‘¥ ç”¨æˆ·ä¸æƒé™</a>
    <a>âš™ï¸ ç³»ç»Ÿé…ç½®</a>
  </nav>

  <main>
    <div class="bar">
      <input id="q" placeholder="è¯·è¾“å…¥å…³é”®è¯ï¼ˆå¦‚ï¼šLog4j / CVE-2021-44228 / æ¨ªå‘ç§»åŠ¨ï¼‰" />
      <button id="btn">æœç´¢</button>
    </div>

    <div class="meta">
      <span class="pill" id="stat">å°±ç»ª</span>
      <span id="lat"></span>
    </div>

    <div class="err" id="err"></div>

    <div class="cards" id="cards"></div>

    <footer>æç¤ºï¼šè¯¥é¡µé¢ä¸ºå½“å‰é˜¶æ®µå‰ç«¯å±•ç¤ºåŸå‹ï¼Œæ•°æ®æ¥è‡ª /api/search åä»£åˆ°åç«¯ 8000ã€‚</footer>
  </main>
</div>

<script>
const $ = (id)=>document.getElementById(id);

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function renderHits(resp){
  const cards = $("cards");
  cards.innerHTML = "";
  const hits = (resp && resp.hits) ? resp.hits : [];
  if(!hits.length){
    cards.innerHTML = `<div class="card"><h3>æ— ç»“æœ</h3><p>æœªæ£€ç´¢åˆ°åŒ¹é…å†…å®¹ï¼Œè¯·æ›´æ¢å…³é”®è¯ã€‚</p></div>`;
    return;
  }
  for(const h of hits){
    const src = h.source || {};
    const title = (h.highlight && h.highlight.title && h.highlight.title[0]) ? h.highlight.title[0] : escapeHtml(src.title||"(æ— æ ‡é¢˜)");
    const content = escapeHtml(src.content||"");
    const docType = escapeHtml(src.doc_type||"");
    const cve = escapeHtml(src.cve_id||"");
    const tags = Array.isArray(src.tags) ? src.tags : [];
    cards.insertAdjacentHTML("beforeend", `
      <div class="card">
        <h3>${title}</h3>
        <p>${content}</p>
        <div class="tags">
          ${docType?`<span class="tag">${docType}</span>`:""}
          ${cve?`<span class="tag">${cve}</span>`:""}
          ${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}
        </div>
      </div>
    `);
  }
}

async function search(){
  const q = $("q").value.trim();
  $("err").style.display="none";
  $("btn").disabled = true;
  $("stat").textContent = "æŸ¥è¯¢ä¸­â€¦";

  const t0 = performance.now();
  try{
    const url = `/api/search?q=${encodeURIComponent(q||"")}`;
    const r = await fetch(url, {headers: {"Accept":"application/json"}});
    const text = await r.text();
    let data;
    try{ data = JSON.parse(text); } catch(e){ throw new Error("è¿”å›éJSONï¼š" + text.slice(0,200)); }
    renderHits(data);
    $("stat").textContent = `OKï¼ˆå‘½ä¸­ ${data?.total?.value ?? 0}ï¼‰`;
  }catch(e){
    $("err").style.display="block";
    $("err").textContent = "è¯·æ±‚å¤±è´¥ï¼š" + (e?.message||e);
    $("stat").textContent = "å¤±è´¥";
  }finally{
    const t1 = performance.now();
    $("lat").textContent = `è€—æ—¶ ${(t1-t0).toFixed(0)} ms`;
    $("btn").disabled = false;
  }
}

$("btn").addEventListener("click", search);
$("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") search(); });

// é»˜è®¤ç»™ä¸€ä¸ªç¤ºä¾‹
$("q").value = "Log4j";
search();
</script>
</body>
</html>
